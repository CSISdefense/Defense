---
title: 'DoD Fixed-Price Study: Contract Duration Classification'
author: "Greg Sanders"
date: "Tuesday, January 13, 2015"
output:
  html_document:
    keep_md: yes
    toc: yes
---

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(plyr)
require(Hmisc)
require(lubridate)
require(scales)
options(error=recover)
setwd("K:\\Development\\Defense")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))

```

```{r setup, echo = TRUE}
SiliconTopVendor  <- read.csv(
    paste("data\\Overall_Location_SP_SiliconValleyTopVendorHistoryPlatformSubCustomer.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )

#These will probably be moved into apply_lookups at some point
SiliconTopVendor<-apply_lookups(Path,SiliconTopVendor)

# 
# as.numeric(as.duration(
#     ymd(ContractSample$SignedMonth)-ContractSample$StartFiscalYear)
#     /dyears(1)
#     )


SiliconTopVendor<-ddply(SiliconTopVendor,
                        .(ParentID),
                        transform,
                        ParentConsolidated=ifelse(sum(ifelse(Customer=="Defense",
                                                             Obligation.2014,
                                                             0),na.rm=TRUE)>=0.25,
                                                  as.character(ParentID),"Other Major Silicon Valley Vendors")
)

SiliconTopVendor$ParentConsolidated<-as.character(SiliconTopVendor$ParentConsolidated)

SiliconTopVendor$ParentConsolidated[SiliconTopVendor$ParentID %in%
                                        c('VARIAN SEMICONDUCTOR EQUIPMENT','VARIAN ASSOCIATES','VARIAN MEDICAL SYSTEMS')]<-
    "Varian Associates & Successors"

ParentOrderDF<-ddply(SiliconTopVendor,
      .(ParentConsolidated),
      summarise,
      Obligation.2014=sum(ifelse(Customer=="Defense",
                                   Obligation.2014,
                                   0),na.rm=TRUE)
)
ParentOrderDF<-ParentOrderDF[order(-ParentOrderDF$Obligation.2014),]

ParentOrderList<-ParentOrderDF$ParentConsolidated
ParentOrderList<-c(unlist(as.character(ParentOrderList[ParentOrderList!="Other Major Silicon Valley Vendors"])),
                   "Other Major Silicon Valley Vendors")

SiliconTopVendor$ParentConsolidated<-factor(SiliconTopVendor$ParentConsolidated,ParentOrderList)

```



```{r PlatformPortfolio}
SiliconTopVendor<-
    ddply(SiliconTopVendor,
                        .(PlatformPortfolio),
                        transform,
                        PlatformPortfolioSC=ifelse(sum(ifelse(Customer=="Defense",
                                                             Obligation.2014,
                                                             0),na.rm=TRUE)>=0.25,
                                                  as.character(PlatformPortfolio),"Remaining Platform Categories")
)


ggplot(data = subset(SiliconTopVendor[order(SiliconTopVendor$PlatformPortfolioSC),],
                     Customer=="Defense" & year(Fiscal.Year)<=2014),# subset(ContractSurvival,StartFiscalYear>=2007 & StartFiscalYear<=2013),
       aes(x=Fiscal.Year,
           y=Obligation.2014,
           fill=PlatformPortfolioSC
           )
       )+ 
    geom_bar(stat="identity") + 
    facet_wrap( ~ ParentConsolidated)+
#                 scales="free_y", #The scales actually do stay fixed
#                 , space="free_y"#But only because the space is free)+
    scale_x_date("Fiscal Year",
                 labels=date_format("'%y"),
                 # breaks="2 years",
                 minor_breaks="1 year",
                 breaks=c(as.Date("1990-01-01"),
                          as.Date("1992-01-01"),
                          as.Date("1994-01-01"),
                          as.Date("1996-01-01"),
                          as.Date("1998-01-01"),
                          as.Date("2000-01-01"),
                          as.Date("2002-01-01"),
                          as.Date("2004-01-01"),
                          as.Date("2006-01-01"),
                          as.Date("2008-01-01"),
                          as.Date("2010-01-01"),
                          as.Date("2012-01-01"),
                          as.Date("2014-01-01"))
                 # breaks=date_breaks("year")
                 # minor_breaks = "1 year"
                 # breaks=date_breaks("year"),
                 # breaks=c(as.Date("1990-01-01"),as.Date("2014-12-31"))
                 )+
    theme(axis.text.x=element_text(angle = 90))+
    scale_y_continuous("Obligations (2014 Dollars Billions)",labels=comma)




```


```{r SubCustomer}


ggplot(data = subset(SiliconTopVendor[order(SiliconTopVendor$SubCustomer.sum),],
                     Customer=="Defense" & year(Fiscal.Year)<=2014),# subset(ContractSurvival,StartFiscalYear>=2007 & StartFiscalYear<=2013),
       aes(x=Fiscal.Year,
           y=Obligation.2014,
           fill=SubCustomer.sum
           )
       )+ 
    geom_bar(stat="identity") + 
    facet_wrap( ~ ParentConsolidated)+
#                 scales="free_y", #The scales actually do stay fixed
#                 , space="free_y"#But only because the space is free)+
    scale_x_date("Fiscal Year",
                 labels=date_format("'%y"),
                 # breaks="2 years",
                 minor_breaks="1 year",
                 breaks=c(as.Date("1990-01-01"),
                          as.Date("1992-01-01"),
                          as.Date("1994-01-01"),
                          as.Date("1996-01-01"),
                          as.Date("1998-01-01"),
                          as.Date("2000-01-01"),
                          as.Date("2002-01-01"),
                          as.Date("2004-01-01"),
                          as.Date("2006-01-01"),
                          as.Date("2008-01-01"),
                          as.Date("2010-01-01"),
                          as.Date("2012-01-01"),
                          as.Date("2014-01-01"))
                 # breaks=date_breaks("year")
                 # minor_breaks = "1 year"
                 # breaks=date_breaks("year"),
                 # breaks=c(as.Date("1990-01-01"),as.Date("2014-12-31"))
                 )+
    theme(axis.text.x=element_text(angle = 90))+
    scale_y_continuous("Obligations (2014 Dollars Billions)",labels=comma)




```


```{r DataExploration}
summary(subset(ContractSample,
               select=c(LastSignedLastDateToOrder,
      LastUltimateCompletionDate,
      LastCurrentCompletionDate,
      UnmodifiedCurrentCompletionDate,
      UnmodifiedUltimateCompletionDate,
      UnmodifiedLastDateToOrder,
      MinOfEffectiveDate,
      MinOfSignedDate
      
                                ))
        )

daysquantile<-quantile(ContractSample$UnmodifiedDays,c(0.25,0.5,0.75),na.rm=TRUE)
exp(quantile(log(ContractSample$UnmodifiedDays),c(0.25,0.5,0.75),na.rm=TRUE))
mean(ContractSample$UnmodifiedDays,na.rm=TRUE)
exp(mean(log(ContractSample$UnmodifiedDays),na.rm=TRUE))
ecdf(ContractSample$UnmodifiedDays)(214)

roundedcutoffs<-c(61,214,364,365,366,367,368,729,730,731,732,733,734)
ecdf(ContractSample$UnmodifiedDays)(roundedcutoffs)


# CompleteContract$LastCurrentCompletionDate<-strptime(CompleteContract$LastCurrentCompletionDate,"%Y-%m-%d") 
# # as.Date(sample.criteria$LastCurrentCompletionDate)
# CompleteContract<-subset(CompleteContract,StartFiscal_Year>=2007 & (LastCurrentCompletionDate<=strptime("2013-09-30","%Y-%m-%d") | IsClosed==1))
# 
# CompleteContract$UnmodifiedDays<-as.numeric(difftime(strptime(CompleteContract$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
#                                                      , strptime(CompleteContract$MinOfEffectiveDate,"%Y-%m-%d")
#                                                      , unit="days"
#         ))+1
dayscompletequantile<-quantile(ContractSample$UnmodifiedDays,c(0.25,0.5,0.75,0.95),na.rm=TRUE)



span <- new_interval(as.POSIXct(ContractSample$UnmodifiedCurrentCompletionDate), 
                     as.POSIXct(ContractSample$MinOfEffectiveDate)) #interval

# summary(eyears(as.period(span)))
# as.period(span, units ="years")
# 2009-01-01 CST--2010-02-02 01:01:01 CST
as.period(span)


dSeconds<-as.duration(strptime(ContractSample$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
                strptime(ContractSample$MinOfEffectiveDate,"%Y-%m-%d"))

summary(dSeconds%/%dyears(1))
# summary(dSeconds/years(1))



#Break the count of days into four categories.
ContractComplete$Dur<-cut2(ContractComplete$UnmodifiedDays,cuts=c(61,214,366,732))
lowroundedcutoffs<-c(15000,100000,1000000,30000000)
highroundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
ContractComplete$qLowCeiling <- cut2(ContractComplete$UnmodifiedContractBaseAndAllOptionsValue,cuts=lowroundedcutoffs)
ContractComplete$qHighCeiling <- cut2(ContractComplete$UnmodifiedContractBaseAndAllOptionsValue,cuts=highroundedcutoffs)
rm(lowroundedcutoffs,highroundedcutoffs)


```

```{r Graphs}

names(CompleteContract)

# 
# ggplot(
#     data = ContractSample,
#     aes_string(x = "UnmodifiedDays",
#                fill = "Dur")
#     ) +     geom_bar(binwidth=7)  +scale_x_continuous(limits=c(0, 2000))
# 
# 
# ggplot(
#     data = ContractSample,
#     aes_string(x = "log(UnmodifiedDays)",
#                 fill = "Dur")
#     ) +     geom_bar(binwidth=0.1)  #+scale_x_continuous(limits=c(0, 2000))


ContractSurvival$SumofObligatedAmount[is.na(ContractSurvival$SumofObligatedAmount)]<-0
ContractSurvival$IsTerminated[is.na(ContractSurvival$IsTerminated)]<-"Unterminated"

#Overall
ggplot(data = ContractSurvival,
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()
    
    # geom_bar(stat="identity",aes(fill=IsTerminated))+

#PSR
ggplot(data = subset(ContractSurvival,PSR!="Mixed or Unlabeled"),
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()+facet_wrap( ~ PSR)


#What
ggplot(data = ContractSurvival,
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()+facet_wrap( ~ What)

# 
# #Who - Not that useful because a lot of big joint contracts get shunted into other DoD
# ggplot(data = ContractSurvival,
#        aes(x=Dur,
#            y=SumofObligatedAmount,
#            fill=Term)
#        )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
#     geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
#     coord_flip()+facet_wrap( ~ Who)

#When
ggplot(data = subset(ContractSurvival,StartFiscalYear>=2007 & StartFiscalYear<=2013),
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()+facet_wrap( ~ StartFiscalYear)


#What
ggplot(data = subset(ContractSurvival,StartFiscalYear==2011& What=="Other" & PSR=="Services"&Who=="Other DoD"),
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()+facet_wrap( ~ Who)


#Intl
ggplot(data = ContractSurvival,
       aes(x=Dur,
           y=SumofObligatedAmount,
           fill=Term)
       )+ geom_bar(stat="identity",subset=.(Term=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(Term=="Terminated"),aes(y=SumofObligatedAmount*(-1)))+
    coord_flip()+facet_wrap( ~ Intl)


ggplot(data = ContractSurvival,
       aes(x=Dur,
           y=ContractCount,
           fill=IsTerminated)
       )+ geom_bar(stat="identity",subset=.(IsTerminated=="Unterminated")) + 
    geom_bar(stat="identity",subset=.(IsTerminated=="Terminated"),aes(y=ContractCount*(-1)))+
    coord_flip()
    
    # geom_bar(stat="identity",aes(fill=IsTerminated))+
    


TerminationSample<-subset(CompleteContract,StartFiscalYear==2011& What=="Other" & PSR=="Services"&Who=="Other DoD"&Term=="Terminated")

write.csv(TerminationSample,paste("Output\\TerminationSample.csv",
                                  sep=""))



```


[$5 billion dollar started in 2011](http://www.law360.com/articles/228410/humana-wins-back-24b-tricare-contract) refers to a contract that was transfered from UnitedHealth Group to Humana. 