---
title: "ChangeOrders"
author: "Greg Sanders"
date: "Friday, March 20, 2015"
output:
  html_document:
    keep_md: yes
--- 

Dod Fixed-Price Study: Costly Change Orders 
============================================================================



```{r Setup, echo = TRUE}
setwd("K:\\Development\\Defense")

Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))
source("ContractCleanup.r")

require(ggplot2)
require(scales)
require(Hmisc)
Coloration<-read.csv(
    paste(Path,"Lookups\\","lookup_coloration.csv",sep=""),
    header=TRUE, sep=",", na.strings="", dec=".", strip.white=TRUE, 
    stringsAsFactors=FALSE
    )

Coloration<-ddply(Coloration
                  , c(.(R), .(G), .(B))
                  , transform
                  , ColorRGB=as.character(
                      if(min(is.na(c(R,G,B)))) {NA} 
                      else {rgb(max(R),max(G),max(B),max=255)}
                      )
                  )

```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..



##Costly Change Orders: existence and number of change orders 

In the same manner as contract terminations, change orders are reported in the *reason for modification* field.  There are two values that this study counts as change orders: "Change Order" and "Definitize Change Order."  For the remainder of this report, contracts with at least one change order are called **Changed Contracts**.  

There are also multiple modifications captured in FPDS that this current study will not investigate as change orders.  These include:

* Additional World (new agreement, FAR part 6 applies)
* Supplemental Agreement for work within scope
* Exercise an Option
* Definitize Letter Contract

In addition, there are a number of other modifications that may be undertaken based on changes on the government or vendor side that are not included in this analysis. 

```{r ReadInData, echo = TRUE}
CompleteModelAndDetail  <- read.csv(
    paste("LargeDatasets\\defense_contract_CSIScontractID_detail.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )






CompleteModelAndDetail<-FormatContractModel(CompleteModelAndDetail)


CompleteModelAndDetail$TermNum<-as.integer(as.character(factor(CompleteModelAndDetail$Term,
                                  levels=c("Terminated","Unterminated"),
                                  labels=c(1,0))))

CompleteModelAndDetail$ObligationWT<-CompleteModelAndDetail$Action.Obligation
CompleteModelAndDetail$ObligationWT[CompleteModelAndDetail$ObligationWT<0]<-NA

CompleteModelAndDetail<-ddply(CompleteModelAndDetail,
                         .(Ceil),
                         
                         plyr::mutate,
                         ceil.median.wt = median(UnmodifiedContractBaseAndAllOptionsValue)
)


CompleteModelAndDetail$UnmodifiedYearsFloat<-CompleteModelAndDetail$UnmodifiedDays/365.25
CompleteModelAndDetail$UnmodifiedYearsCat<-floor(CompleteModelAndDetail$UnmodifiedYearsFloat)
CompleteModelAndDetail$Dur[CompleteModelAndDetail$UnmodifiedYearsCat<0]<-NA

CompleteModelAndDetail$Dur.Simple<-as.character(CompleteModelAndDetail$Dur)
CompleteModelAndDetail$Dur.Simple[CompleteModelAndDetail$Dur.Simple %in% c(
    "[0 months,~2 months)",
    "[~2 months,~7 months)",
    "[~7 months-~1 year]")]<-"<~1 year"
CompleteModelAndDetail$Dur.Simple<-factor(CompleteModelAndDetail$Dur.Simple,
                                          levels=c("<~1 year",
                                               "(~1 year,~2 years]",
                                               "(~2 years+]"),
                                   ordered=TRUE
                                   )

CompleteModelAndDetail$Ceil.Simple<-as.character(CompleteModelAndDetail$Ceil)

CompleteModelAndDetail$Ceil.Simple[CompleteModelAndDetail$Ceil.Simple %in% c(
    "75m+",
    "10m - <75m")]<-"10m+"
CompleteModelAndDetail$Ceil.Simple[CompleteModelAndDetail$Ceil.Simple %in% c(
    "1m - <10m",
    "100k - <1m")]<-"100k - <10m"
CompleteModelAndDetail$Ceil.Simple[CompleteModelAndDetail$Ceil.Simple %in% c(
    "15k - <100k",
    "0 - <15k")]<-"0k - <100k"
CompleteModelAndDetail$Ceil.Simple<-factor(CompleteModelAndDetail$Ceil.Simple,
       levels=c("0k - <100k",
                "100k - <10m",
                "10m+"),
       ordered=TRUE
       )

CompleteModelAndDetail$pNewWork4Sig<-round(pNewWorkUnmodifiedBaseAndAll,4)
CompleteModelAndDetail$pChange4Sig<-pChangeOrderUnmodifiedBaseAndAll


```


**A histogram of the data** showing the distribution of the number of change orders each year from 2007.


```{r ChangeOrders, echo = TRUE, fig.width=4.5,fig.height=6}

ggplot(
  data = CompleteModelAndDetail,
  aes_string(x = "ChangeOrderBaseAndAllOptionsValue")
  ) + scale_x_log10()+
 geom_histogram(binwidth=0.25) +
  facet_wrap("StartFiscalYear")



CompleteModelAndDetail$Graph[CompleteModelAndDetail$SumOfisChangeOrder>0]<-TRUE
CompleteModelAndDetail$Graph[CompleteModelAndDetail$SumOfisChangeOrder==0]<-FALSE

CompleteModelAndDetail$ContractCount<-1
CompleteModelAndDetail<-ddply(CompleteModelAndDetail, .(Ceil), transform, pContract=ContractCount/sum(ContractCount))
CompleteModelAndDetail<-ddply(CompleteModelAndDetail, .(Ceil), transform, pObligation=Action.Obligation/sum(Action.Obligation))
CompleteModelAndDetail$pTotalObligation<-CompleteModelAndDetail$Action.Obligation/sum(CompleteModelAndDetail$Action.Obligation,na.rm=TRUE)


ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "SumOfisChangeOrder"),
  ) + geom_bar(binwidth=1) + 
    facet_grid( Ceil ~ .,
                scales = "free_y",
                space = "free_y") + scale_y_continuous(expand = c(0,50)) +scale_x_continuous(limits=c(0,10))



ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil")
  )+ geom_bar()+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+scale_y_continuous("Number of Contracts with Change Orders")+theme(axis.text.x=element_text(angle=90))



ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="pContract")
#   main="Percentage of Contracts going to Partially or Completely Terminated Contracts\nBy Initial Contract Ceiling"
  )+ geom_bar()+ scale_y_continuous("Percent of Contracts with Change Orders", labels=percent)+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90))


ggplot(
  data =subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="pObligation"),
  main="Percentage of Contract Obligations going to Contracts with Change Orders\nBy Initial Contract Ceiling"
  )+ geom_bar()+ scale_y_continuous("Percent of Obligations in Cost Ceiling Category", labels=percent)+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90))


ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="Action.Obligation")
  )+ geom_bar()+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+scale_y_continuous("Total Obligated Value of Contracts with Change Orders")+theme(axis.text.x=element_text(angle=90))





summary(subset(CompleteModelAndDetail$qCRais,CompleteModelAndDetail$SumOfisChangeOrder>0    ))
```


## Costly Change Orders Potential Change Cost 

###size of change orders measured by raise of ceiling

This study uses changes in the *Base and All Options Value Amount* as a way of tracking the potential cost of change orders.

* The *Base and All Options Value Amount* refers to the ceiling of contract costs if all available options were exercised. 
* The *Base and Exercised Value Amount* is not used because contracts are often specified such that the bulk of the eventually executed contract in dollar terms are treated as options.  In these cases, the all-inclusive value provides a better baseline for tracking growth.  
* The *Action Obligation* refers to the actual amount transferred to vendors.  This study team does not use this value because spending for change orders are not necessarily front-loaded.  For example, a change to a contract in May of 2010 could easily result in payments from May 2010 through August 2013.

The % Growth in Base and All Options Value Amount form Change Orders is calculated as follows: 

*Base and All Options Value Amount* increases for all Change Order Modifications/
*Base and All Options Value Amount* from the original unmodified contract transaction


**A histogram of the data** showing the distribution of the initial amount of the specific change order 


```{r CeilBreachSummary}
ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="pContract")
#   main="Percentage of Contracts going to Partially or Completely Terminated Contracts\nBy Initial Contract Ceiling"
  )+ geom_bar()+ scale_y_continuous("Percent of Contracts with Change Orders", labels=percent)+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")


ggplot(
  data =subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="pObligation"),
  main="Percentage of Contract Obligations going to Contracts with Change Orders\nBy Initial Contract Ceiling"
  )+ geom_bar()+ scale_y_continuous("Percent of Obligations in Cost Ceiling Category", labels=percent)+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")


ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "Ceil",weight="Action.Obligation")
  )+ geom_bar()+
    scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+scale_y_continuous("Total Obligated Value of Contracts with Change Orders")


```

```{r CeilingBreachDetailed, echo = TRUE, fig.width=6.5,fig.height=6}


ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "pChangeOrderUnmodifiedBaseAndAll")
  ) + geom_bar(binwidth=0.01) + 
    facet_grid( Ceil ~ .,
                scales = "free_y",
                space = "free_y") +   
    scale_y_continuous("Number of Contracts with Change Orders")+
    scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders b
                       y\nInitial Cost Ceiling (Current $ Value)",
                       limits=c(-1.25,1.25), labels=percent)+
    theme(axis.text.x=element_text(angle=90,size=1))

ggplot(
  data = subset(CompleteModelAndDetail,SumOfisChangeOrder>0),
  aes_string(x = "pChangeOrderUnmodifiedBaseAndAll")
  )+ geom_bar()+
#     scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders by\nInitial Cost Ceiling (Current $ Value)")
    scale_y_continuous("Number of Contracts with Change Orders")+
        facet_grid( . ~ Ceil ) +
    scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders by\nInitial Cost Ceiling (Current $ Value)", limits=c(-1.25,1.25), labels=percent)+
    theme(axis.title.x=element_text(angle=90))


BreachSummary<-ddply(CompleteModelAndDetail,.(Ceil,pChangeOrderUnmodifiedBaseAndAll,SumOfisChangeOrder,CRai,Term),
                     summarise,
                     pContract=sum(pContract),
                     pObligation=sum(pObligation),
                     pTotalObligation=sum(pTotalObligation))


# Percent of Contracts breakdown
ggplot(
  data = subset(BreachSummary,SumOfisChangeOrder>0),
  aes_string(x = "pChangeOrderUnmodifiedBaseAndAll",weight="pContract",fill="CRai")#
  )+ geom_bar(binwidth=0.05)+
#     scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders by\nInitial Cost Ceiling (Current $ Value)")
    scale_y_continuous("Percent of Contracts", labels=percent)+
        facet_grid( . ~ Ceil )+scale_x_continuous("Extent of Ceiling Breach in 5% Increments",limits=c(-0.5,1), labels=percent)+theme(axis.text.x=element_text(angle=90),legend.position="bottom")+scale_fill_discrete(name="Extent of Ceiling Breach")
```

```{r CeilingBreachObligations, echo = TRUE, fig.width=6.5,fig.height=6}



#Percent of obligations breakdown
ggplot(
  data = subset(BreachSummary,SumOfisChangeOrder>0),
  aes_string(x = "pChangeOrderUnmodifiedBaseAndAll",weight="pTotalObligation",fill="CRai")#
  )+ geom_bar(binwidth=0.01)+
#     scale_x_continuous("Percentage of Obligations  by\nInitial Cost Ceiling (Current $ Value)")
    scale_y_continuous("Percent of Completed Contracts\n(Weighted by Current $ Obligations)", labels=percent)+
       # facet_grid( . ~ Term )+
    scale_x_continuous("Extent of Ceiling Breach \n(Percent Change in Current $ Value in 1% Increments)",labels=percent,limits=c(-0.5,1))+
    coord_cartesian(xlim=c(-0.5,1))+ theme(axis.text.x=element_text(angle=90),legend.position="bottom")+
    scale_fill_discrete(name="Extent of Ceiling Breach")



tapply(CompleteModelAndDetail$CRai, CompleteModelAndDetail$Ceil, summary)

ddply(subset(CompleteModelAndDetail,SumOfisChangeOrder>0),.(Ceil,CRai),
                     summarise,
                     pContract=sum(pContract), 
      pObligation=sum(pObligation),
                     pTotalObligation=sum(pTotalObligation))


ddply(subset(CompleteModelAndDetail,SumOfisChangeOrder>0),.(Term,CRai),
                     summarise,
                     pTotalObligation=sum(pTotalObligation))


ddply(subset(CompleteModelAndDetail,SumOfisChangeOrder>0),.(CRai),
                     summarise,
                     pTotalObligation=sum(pTotalObligation))

sum(subset(CompleteModelAndDetail,SumOfisChangeOrder>0)$pTotalObligation)
sum(subset(CompleteModelAndDetail,pChangeOrderUnmodifiedBaseAndAll>0)$pTotalObligation)

```


